#!/usr/bin/env python
"""
The purpose of this project is to create a command line utility called 
perflogger to measure the performance of commands and other utilities. 
This module will capture run time environment and performance data from 
outputs of commands that have been run with this module. Information will 
be parsed into a JSON document and inserted into an index in the Elasticsearch 
database using the Python Elasticsearch Client. With the performance data in 
the Elasticsearch database, further exploration and analysis on the data can 
be done on Kibana, which is a data visualization plugin for Elasticsearch.
"""
import elasticsearch
import time
import sys
import argparse
import logging
import subprocess
import os
import platform

from perflogger import Perf


def parseArguments():
    parser = argparse.ArgumentParser(
            usage = 'perflogger [-h] [-d] [-p PROJECT] command [command options] [command args]',
            formatter_class=argparse.RawDescriptionHelpFormatter,
            description=__doc__)
    parser.add_argument("command", type=str, nargs="+",
            help="command to run with additional options and arguments")
    parser.add_argument('-d', "--debugging", action='store_true', 
            default=False, help="print detailed debugging information")
    parser.add_argument('-p', "--project", 
            help="the project that the command is being run for")

    return parser.parse_known_args()


def runCommand(command):
    """
    Run the command and get the performance time. 

    Keyword argument:
    -----------------
    command         -- command to be run
    """
    # Run command and get performance data
    start = time.time()
    p = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    out, err = p.communicate()
    end = time.time()
    sys.stdout.write(out)
    sys.stderr.write(err)
    logging.debug("Command: %s; Output: %s; Error: %s", command, out, err)
    return end - start


def insertToESDB ():
    """
    Create an index (if not exists) and insert the json into it

    Keyword argument:
    -----------------
    json    -- JSON with relevant data
    """
    # Create index

    # Insert into index
    print "Inserting json into Elasticsearch Database..."


def main():
    args, argv = parseArguments()
    if args.debugging:
        logging.basicConfig(level=logging.DEBUG, 
                format='%(asctime)s %(message)s',
                datefmt='%I:%M:%S')
    else:
        logging.basicConfig(format='%(asctime)s %(message)s',
            datefmt='%I:%M:%S')

    perf = Perf(args, argv)
    cmdTime = runCommand(args.command +  argv)
    perf.setPerfTime(cmdTime)
    perf.parseToJSON()
    insertToESDB()

if __name__ == '__main__':
    main()
